我对你的要求理解如下（先确认口径）：

  - 以 /root/perfvec/block_trace/tracer/scripts/trace_wrapper.sh 为入口，梳理并跑通整个 block-trace pipeline；
  - 需要把它从原作者硬编码路径（/home/chiplab/PRL/PerfVec/...、/home/chiplab/miniconda3/...）适配到当前服务器 /root 的文件环境；
  - 最终运行时以 llmulator 这个 conda 环境为主（至少 Python/依赖要在该环境下可用；LLVM/gem5 等依赖也尽量在此环境可控）；
  - 同时你提供了 /root/gem5-ml-sim，需要用它来作为 gem5（原 repo 里的 perfvec/block_trace/gem5 目前是空目录）。

  我已经从仓库里确认到的关键事实/风险点：

  - trace_wrapper.sh 会：编译 bitcode → opt 插桩 pass（含 BBTRACE_STATIC_ONLY=1 的“无插桩静态信息版”）→ 运行插桩/无插桩二进制 → 生成 pcmap/instmap → 跑两次 gem5（一次 traced、一次 plain 并导出
    μOP trace）→ 排序 μOP trace → 生成 bbtrace_ordered_full → 做符号地址差异。
  - 代码/脚本大量硬编码 /home/chiplab/...：trace_wrapper.sh、run_example.sh、build.sh、CMake 的 LLVM_INSTALL_PREFIX、extract_pcmap.py/extract_inst_map.py 默认 llvm 工具路径等。
  - 当前机器 系统已安装 LLVM 22 在 /usr/lib/llvm-22（含 bin/clang/opt/llvm-objcopy/llvm-readelf/llvm-nm、以及 lib/cmake/llvm），所以 LLVM 这一块不必从零编译即可跑通 pass。
  - gem5-ml-sim 里确实有 MicroOpVerboseTracer（实现文件 src/cpu/uop_tracer.*），但目前 configs 里没有看到 --uop-trace-path/--uop-trace-buffer 这类参数接入；而 trace_wrapper.sh 会把这两个参数作为
    se.py 的脚本参数传入，如果 se.py 不认识会直接 argparse 报错——这是端到端跑通的最大阻塞点之一（后续需要改 gem5 configs 或改 wrapper）。
  - llmulator 环境可运行（Python 3.10），但 conda 在该沙箱下有一个已知问题：默认会触发 CUDA 虚拟包检测用到进程信号量（/dev/shm 在 sandbox 下不可写），因此需要在执行 conda 管理命令时设置
    CONDA_OVERRIDE_CUDA="" 来绕开检测。

  下面是一个“能落地执行”的行动计划（先不改项目代码）：

  1. 确定适配策略（两条路二选一）

  - A. “零改代码、用兼容路径”路线：在 /home/chiplab/PRL/PerfVec 下做软链接/目录映射，让脚本硬编码路径在本机也成立（最快，但需要在 /home 下创建目录/链接，通常会触发本工具的沙箱写权限审批）。
  - B. “改脚本为相对路径/可配置”路线：后续直接改 trace_wrapper.sh/build.sh/CMake 等，把 PROJECT_ROOT/LLVM_HOME/GEM5_ROOT 改成从脚本位置推导或从环境变量/参数读取（更干净，但你这条消息要求“先不要
    修改代码”，所以这一步放到后续执行阶段）。

  2. 先把 LLVM 侧跑通（不依赖 gem5）

  - 用系统 LLVM 22：把“脚本期待的 llvm-install”映射到 /usr/lib/llvm-22（走路线 A 就做链接；走路线 B 就后续改参数）。
  - 构建 tracer：运行 perfvec/block_trace/tracer/scripts/build.sh（它会 cmake + build 出 build/passes/libBasicBlockTracer.so 和 build/runtime/libbbtrace_runtime.a）。
  - 用 run_example.sh 先验证插桩/运行/trace 生成链路：确认 bbtrace-*.jsonl、bbtrace_static/*.bbinfo.jsonl、extract_pcmap.py 都能正常输出。

  3. 准备并构建 gem5（用 /root/gem5-ml-sim）

  - 目标产物：/root/gem5-ml-sim/build/X86/gem5.fast（当前未编译）。
  - 建议用 llmulator 的 Python 来驱动构建（避免 base conda 的 Python 3.13 干扰）：可以用 conda run -n llmulator python3 /usr/bin/scons ... 的方式（必要时加 PYTHONPATH=/usr/lib/python3/dist-
    packages 让 conda python 能 import 系统的 SCons）。

  4. 解决端到端阻塞点：让 gem5 接受 wrapper 的 μOP 参数
     你有两种主修方案（后续需要改代码，但这是跑通 wrapper 的关键）：

  - 方案 4A（推荐，改 gem5 configs）：在 gem5-ml-sim/configs/common/Options.py 或 configs/deprecated/example/se.py 增加 argparse 选项 --uop-trace-path、--uop-trace-buffer，并在建好 system.cpu 后
    把 cpu.tracer 切到 MicroOpVerboseTracer(output_path=..., buffer_size=...)。这样 trace_wrapper.sh 不用改。
  - 方案 4B（改 wrapper）：不再传 --uop-trace-path/--uop-trace-buffer，改为用 gem5 原生 --param 机制设置 system.cpu.tracer=MicroOpVerboseTracer 及其参数，或从 m5out 里抓默认生成的
    uoptrace.*.jsonl。这样改动集中在 tracer 项目，但要小心兼容 se.py 的参数解析。

  5. 最终验收：在 llmulator 环境下跑 wrapper

  - 用 conda run -n llmulator 执行 trace_wrapper.sh（确保 python3 走 env）。
  - 验收输出目录里至少包含：with_trace/trace_logs/bbtrace-*.jsonl、without_trace/*.pcmap、gem5_runtime/without_trace/uop_trace/*.jsonl、bbtrace_ordered_full.txt、address_diff.json。

  需要你确认的两个选择（我后续才能按你偏好推进实施）：

  - 你更想用哪条适配路线？A：做 /home/chiplab/PRL/PerfVec 软链接兼容（少改代码但要动系统路径），还是 B：直接把脚本/CMake 改成相对路径+参数化（更规范）？
  - 你希望 μOP trace 这块优先改哪边？4A 改 gem5 configs（wrapper 不动），还是 4B 改 wrapper（gem5 configs 尽量不动）？

---

## 已完成的环境适配与操作记录（路线 B + 方案 4A）

### 目标

- 让 `/root/perfvec/block_trace/tracer/scripts/trace_wrapper.sh` 在本机路径结构下可运行（不依赖 `/home/chiplab/...`）。
- gem5 使用 `/root/gem5-ml-sim`，并支持 wrapper 传入的 `--uop-trace-path/--uop-trace-buffer`。
- 尽量在 `llmulator` conda 环境中完成编译/运行（Python 3.10）。

### 关键修改点（为了让脚本能在 /root 跑起来）

**tracer（/root/perfvec/block_trace/tracer）**

- `perfvec/block_trace/tracer/scripts/build.sh`：改为从脚本位置推导 `PROJECT_ROOT`，并支持用 `LLVM_HOME` 指定 LLVM；默认优先用 `/usr/lib/llvm-22`。
- `perfvec/block_trace/tracer/scripts/run_example.sh`：改为相对路径推导 `PROJECT_ROOT`/`BLOCK_TRACE_ROOT`，并自动探测 `LLVM_HOME`。
- `perfvec/block_trace/tracer/scripts/trace_wrapper.sh`：
  - 改为相对路径推导 `PROJECT_ROOT/BLOCK_TRACE_ROOT/REPO_ROOT`；
  - 自动探测 `GEM5_ROOT`（优先 `/root/gem5-ml-sim`），并允许用环境变量覆盖；
  - 默认 `LLVM_HOME` 使用 `/usr/lib/llvm-22`；
  - `GEM5_PYTHON_LIB` 默认从 `CONDA_PREFIX/lib` 推导（用于 gem5 运行时 `LD_LIBRARY_PATH`）。
- `perfvec/block_trace/tracer/CMakeLists.txt`：
  - `project(... LANGUAGES C CXX)`（LLVM 的 cmake 模块会做 C 级探测）；
  - 默认寻找系统 LLVM（`/usr/lib/llvm-22`），也支持 `LLVM_HOME` 和 `-DLLVM_INSTALL_PREFIX=...`；
  - 修正 LLVM 的 `LLVM_DEFINITIONS` 注入方式（用 `add_compile_options` 而不是 `add_compile_definitions`）；
  - 为缺失的 `zstd::libzstd_shared` / `CURL::libcurl` 提供最小 IMPORTED target 兜底（避免系统 LLVM cmake 配置导致 target 缺失）。
- `perfvec/block_trace/tracer/scripts/extract_pcmap.py`、`perfvec/block_trace/tracer/scripts/extract_inst_map.py`：
  - 默认通过 `shutil.which(...)` 查找 `llvm-objcopy/llvm-readelf`，不再固定 `/home/chiplab/...`。

**gem5（/root/gem5-ml-sim）**

- `gem5-ml-sim/configs/common/Options.py`：在 `addSEOptions` 增加参数：
  - `--uop-trace-path`（空表示禁用）
  - `--uop-trace-buffer`（默认 `8GB`）
- `gem5-ml-sim/configs/deprecated/example/se.py`：
  - 若 `args.uop_trace_path` 非空，则把每个 `cpu.tracer` 设置为 `MicroOpVerboseTracer(output_path=..., buffer_size=...)`（方案 4A）。
- `gem5-ml-sim/src/cpu/uop_tracer.hh` / `gem5-ml-sim/src/cpu/uop_tracer.cc`：
  - 增加并使用 `std::atomic<uint64_t>` 计数器，修复编译错误（`recordRequests/recordsWritten/...` 未定义）。

### 实际执行过的命令（按顺序）

#### 1) tracer：构建 pass + runtime

在 `llmulator` 环境中构建（推荐）：

```bash
conda run -n llmulator bash -lc '
cd /root/perfvec/block_trace/tracer
./scripts/build.sh
'
```

说明：

- 本机使用系统 LLVM：`/usr/lib/llvm-22`（包含 `clang/opt/llvm-objcopy/llvm-readelf/llvm-nm` 等）。

#### 2) gem5：编译 /root/gem5-ml-sim 的 build/X86/gem5.fast

关键点：

- gem5 构建阶段的嵌入式 Python 探测会使用 `python3-config`；
- 由于 base conda（Python 3.13）会污染 `PATH`，必须强制使用系统 Python 3.10 的 `python3-config`；
- 同时跳过 `pre-commit` hooks 的交互式提示（无网络时无法安装 `pre-commit`）。

推荐在 `llmulator` 环境中运行：

```bash
conda run -n llmulator bash -lc '
cd /root/gem5-ml-sim
export PYTHON_CONFIG=/usr/bin/python3-config
export PATH=/usr/bin:/bin:/usr/sbin:/sbin
/usr/bin/scons --ignore-style build/X86/gem5.fast -j1
'
```

说明：

- `-j1` 是为了便于定位错误；稳定后可改为 `-j8` 或 `-j$(nproc)`。

#### 3) 验证 gem5 se.py 已支持 uop-trace 参数

```bash
/root/gem5-ml-sim/build/X86/gem5.fast \
  /root/gem5-ml-sim/configs/deprecated/example/se.py --help | grep -n "uop-trace"
```

备注：

- `llmulator` 里未必有 `rg`，因此用 `grep`；如果把 `--help` 管道到不存在的命令会出现 `BrokenPipeError`，这不是 gem5 本身失败。

#### 4) 最终：运行 trace_wrapper（端到端）

```bash
conda run -n llmulator bash -lc '
cd /root/perfvec/block_trace/tracer
export LLVM_HOME=/usr/lib/llvm-22
export GEM5_ROOT=/root/gem5-ml-sim
./scripts/trace_wrapper.sh --src ./examples/matmul.c --name matmul_demo
'
```

### 已知 warning（可忽略）

- gem5 编译时可能提示缺少 `tcmalloc/protoc/capstone/png/hdf5`：这些是可选功能，不影响 `se.py + MicroOpVerboseTracer` 主流程。
- `warn: Base 10 memory/cache size 8GB will be cast to base 2 size 8GiB.`：单位转换提醒，不影响运行。

------------

log....
(llmulator) root@aae9b130f54b:~/gem5-ml-sim# /root/gem5-ml-sim/build/X86/gem5.fast /root/gem5-ml-sim/configs/deprecated/example/se.py --help | grep -n "uop-trace"
warn: Base 10 memory/cache size 8GB will be cast to base 2 size 8GiB.
warn: The se.py script is deprecated. It will be removed in future releases of  gem5.
69:             [--uop-trace-path UOP_TRACE_PATH]
70:             [--uop-trace-buffer UOP_TRACE_BUFFER]
299:  --uop-trace-path UOP_TRACE_PATH
301:  --uop-trace-buffer UOP_TRACE_BUFFER
(llmulator) root@aae9b130f54b:~/gem5-ml-sim# cd /root/perfvec/block_trace/tracer
(llmulator) root@aae9b130f54b:~/perfvec/block_trace/tracer# export LLVM_HOME=/usr/lib/llvm-22
(llmulator) root@aae9b130f54b:~/perfvec/block_trace/tracer# export GEM5_ROOT=/root/gem5-ml-sim
(llmulator) root@aae9b130f54b:~/perfvec/block_trace/tracer# ./scripts/trace_wrapper.sh --src ./examples/matmul.c --name matmul_demo
[trace-wrapper] 源码: ./examples/matmul.c
[trace-wrapper] 输出目录: /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055745
[trace-wrapper] 1/8: clang 生成 bitcode...
clang: warning: argument unused during compilation: '-no-pie' [-Wunused-command-line-argument]
[trace-wrapper] 2/8: 运行 bb-trace (static-only) 生成无插桩版本...
[trace-wrapper] plain bbinfo 导出到 /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055745/without_trace/bbtrace_static_export
[trace-wrapper] 3/8: 构建 & 运行无插桩可执行...
setarch: failed to set personality to x86_64: Operation not permitted
[trace-wrapper] 无插桩版本运行失败，退出码 1
(llmulator) root@aae9b130f54b:~/perfvec/block_trace/tracer# ./scripts/trace_wrapper.sh --src ./examples/matmul.c --name matmul_demo
[trace-wrapper] WARNING: setarch 存在但无法关闭 ASLR（可能被容器/安全策略禁用），将继续运行
[trace-wrapper] 源码: ./examples/matmul.c
[trace-wrapper] 输出目录: /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941
[trace-wrapper] 1/8: clang 生成 bitcode...
clang: warning: argument unused during compilation: '-no-pie' [-Wunused-command-line-argument]
[trace-wrapper] 2/8: 运行 bb-trace (static-only) 生成无插桩版本...
[trace-wrapper] plain bbinfo 导出到 /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/without_trace/bbtrace_static_export
[trace-wrapper] 3/8: 构建 & 运行无插桩可执行...
checksum=72385.0000
[trace-wrapper] 4/8: 生成插桩版本并运行...
[trace-wrapper] traced bbinfo 导出到 /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/with_trace/bbtrace_static_export
checksum=72385.0000
[trace-wrapper] JSONL trace: /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/with_trace/trace_logs/bbtrace-4008405-20260105-055942.jsonl
[trace-wrapper] 5/8: 生成 bbtrace_ordered_trace...
[trace-wrapper] 6/8: 导出 pcmap（trace/plain）...
[trace-wrapper] 7/8: gem5.fast 运行 LLVM trace 版本（无 μOP 导出）...
warn: Base 10 memory/cache size 8GB will be cast to base 2 size 8GiB.
warn: The se.py script is deprecated. It will be removed in future releases of  gem5.
Global frequency set at 1000000000000 ticks per second
warn: failed to generate dot output from /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/gem5_runtime/with_trace/config.dot
src/mem/dram_interface.cc:690: warn: DRAM device capacity (8192 Mbytes) does not match the address range assigned (512 Mbytes)
src/base/statistics.hh:279: warn: One of the stats is a legacy stat. Legacy stat is a stat that does not belong to any statistics::Group. Legacy stat is deprecated.
system.remote_gdb: Listening for connections on port 7000
gem5 Simulator System.  https://www.gem5.org
gem5 is copyrighted software; use the --copyright option for details.

gem5 version 25.0.0.1
gem5 compiled Jan  5 2026 05:53:18
gem5 started Jan  5 2026 05:59:43
gem5 executing on aae9b130f54b, pid 4008462
command line: /root/gem5-ml-sim/build/X86/gem5.fast --outdir /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/gem5_runtime/with_trace /root/gem5-ml-sim/configs/deprecated/example/se.py --cmd /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/with_trace/matmul_demo_traced --cpu-type=TimingSimpleCPU --sys-clock=1GHz --cpu-clock=2GHz --env /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/gem5_runtime/with_trace/process.env

**** REAL SIMULATION ****
src/sim/mem_state.cc:443: info: Increasing stack size by one page.
src/sim/syscall_emul.cc:86: warn: ignoring syscall mprotect(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall mprotect(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall set_robust_list(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall rseq(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall mprotect(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall mprotect(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall mprotect(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall mprotect(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall mprotect(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall mprotect(...)
src/sim/mem_state.cc:443: info: Increasing stack size by one page.
src/sim/mem_state.cc:443: info: Increasing stack size by one page.
checksum=72385.0000
Exiting @ tick 1102514357000 because exiting with last active thread context
[trace-wrapper] 8/8: gem5.fast 运行无 LLVM trace 版本（导出 μOP）...
warn: Base 10 memory/cache size 8GB will be cast to base 2 size 8GiB.
warn: The se.py script is deprecated. It will be removed in future releases of  gem5.
warn: Base 10 memory/cache size 8GB will be cast to base 2 size 8GiB.
Global frequency set at 1000000000000 ticks per second
warn: failed to generate dot output from /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/gem5_runtime/without_trace/config.dot
src/mem/dram_interface.cc:690: warn: DRAM device capacity (8192 Mbytes) does not match the address range assigned (512 Mbytes)
src/base/statistics.hh:279: warn: One of the stats is a legacy stat. Legacy stat is a stat that does not belong to any statistics::Group. Legacy stat is deprecated.
system.remote_gdb: Listening for connections on port 7000
gem5 Simulator System.  https://www.gem5.org
gem5 is copyrighted software; use the --copyright option for details.

gem5 version 25.0.0.1
gem5 compiled Jan  5 2026 05:53:18
gem5 started Jan  5 2026 06:01:31
gem5 executing on aae9b130f54b, pid 4008907
command line: /root/gem5-ml-sim/build/X86/gem5.fast --outdir /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/gem5_runtime/without_trace /root/gem5-ml-sim/configs/deprecated/example/se.py --cmd /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/without_trace/matmul_demo_plain --cpu-type=TimingSimpleCPU --sys-clock=1GHz --cpu-clock=2GHz --env /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/gem5_runtime/without_trace/process.env --uop-trace-path /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/gem5_runtime/without_trace/uop_trace/matmul_demo_plain_uops.jsonl --uop-trace-buffer 8GB

**** REAL SIMULATION ****
src/sim/mem_state.cc:443: info: Increasing stack size by one page.
src/sim/syscall_emul.cc:86: warn: ignoring syscall mprotect(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall mprotect(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall set_robust_list(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall rseq(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall mprotect(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall mprotect(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall mprotect(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall mprotect(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall mprotect(...)
src/sim/syscall_emul.cc:86: warn: ignoring syscall mprotect(...)
checksum=72385.0000
src/cpu/uop_tracer.cc:66: info: MicroOpVerboseTracer[system.cpu.tracer]: requests=3509819, written=3509499, drop_no_thread=0, drop_no_inst=0
Exiting @ tick 171007620000 because exiting with last active thread context
[trace-wrapper] μOP trace 按 PC 重排序...
[trace-wrapper] 补充：生成 bbtrace_ordered_full（按 plain 地址+μOP）...
[trace-wrapper] 附加：比较符号地址...
[trace-wrapper] 8/9: 比较符号地址...
[trace-wrapper] 任务完成。
[trace-wrapper] 插桩输出: /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/with_trace
[trace-wrapper] 无插桩输出: /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/without_trace
[trace-wrapper] gem5 traced 输出: /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/gem5_runtime/with_trace
[trace-wrapper] gem5 plain 输出: /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/gem5_runtime/without_trace
[trace-wrapper] μOP trace: /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/gem5_runtime/without_trace/uop_trace/matmul_demo_plain_uops.jsonl.pc_sorted
[trace-wrapper] 符号差异: /root/perfvec/block_trace/tracer/build/wrapper_runs/matmul_demo/20260105-055941/address_diff.json
[trace-wrapper] QEMU externbb 流程暂时已禁用。